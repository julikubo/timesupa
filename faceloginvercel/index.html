<!doctype html>
<html lang="pt-br">

<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>TimeSupa - Login Facial (Vercel)</title>
    <style>
        body {
            margin: 0;
            display: flex;
            justify-content: center;
            align-items: center;
            background: #222;
            color: white;
            font-family: sans-serif;
            height: 100vh;
            flex-direction: column;
            transition: background 0.3s;
        }

        video {
            position: absolute;
            inset: 0;
            width: 100%;
            height: 100%;
            object-fit: cover;
            transform: scaleX(-1);
            z-index: -1;
        }

        #msg {
            position: absolute;
            top: 10px;
            left: 10px;
            padding: 10px 20px;
            background: rgba(0, 0, 0, 0.5);
            border-radius: 8px;
            font-size: 1em;
            text-align: left;
            z-index: 10;
        }

        canvas {
            position: absolute;
            inset: 0;
            width: 100%;
            height: 100%;
            object-fit: cover;
        }

        .loading-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.8);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 100;
            display: none;
        }

        .loading-text {
            font-size: 1.5em;
            color: #fff;
        }
    </style>
</head>

<body>
    <video id="video" autoplay muted playsinline></video>
    <div id="msg">Carregando modelos…</div>

    <div id="loading" class="loading-overlay">
        <div class="loading-text">Autenticando...</div>
    </div>

    <!-- Import face-api.js -->
    <script src="https://cdn.jsdelivr.net/npm/face-api.js@0.22.2/dist/face-api.min.js"></script>

    <!-- Import Supabase JS -->
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

    <script>
        // Configurações do Supabase e Credenciais de Auto-Login (Necessárias para o Fallback)
        const SUPABASE_URL = 'https://nljeheupokqsvsuudlvt.supabase.co';
        const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Im5samVoZXVwb2txc3ZzdXVkbHZ0Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjAyMTMyODUsImV4cCI6MjA3NTc4OTI4NX0._SlcHYKtEbmDosDCVHNtLySgtlglnMnODBQH5O1QE70';

        const AUTO_EMAIL = 'julikubo@gmail.com';
        const AUTO_PASSWORD = 'leandrok';

        // Inicializa Supabase
        const supabase = supaBase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

        const video = document.getElementById('video');
        const msg = document.getElementById('msg');
        const loading = document.getElementById('loading');
        let faceMatcher = null;
        let isRecognitionRunning = false;
        let isAuthenticating = false;

        // Caminhos para os recursos (relativos a este arquivo)
        const MODELS_PATH = 'assets/models';
        const FACES_JSON_PATH = 'assets/faces.json';
        const LABELED_IMAGES_PATH = 'assets/labeled_images';

        // Carregar modelos e iniciar câmera
        Promise.all([
            faceapi.nets.ssdMobilenetv1.loadFromUri(MODELS_PATH),
            faceapi.nets.faceLandmark68Net.loadFromUri(MODELS_PATH),
            faceapi.nets.faceRecognitionNet.loadFromUri(MODELS_PATH)
        ]).then(startCamera).catch(err => {
            console.error(err);
            msg.textContent = "Erro ao carregar modelos: " + err;
        });

        async function startCamera() {
            msg.textContent = "Iniciando câmera…";
            try {
                const stream = await navigator.mediaDevices.getUserMedia({
                    video: { width: 640, height: 480, facingMode: "user" }
                });
                video.srcObject = stream;

                // Carregamento inicial das imagens
                await loadLabeledImages();

            } catch (err) {
                console.error(err);
                msg.textContent = "Erro na câmera: " + err;
            }
        }

        async function loadLabeledImages() {
            msg.textContent = "Carregando dados faciais…";

            try {
                const response = await fetch(FACES_JSON_PATH);
                const imageFiles = await response.json();

                if (imageFiles.length === 0) {
                    msg.textContent = "Nenhuma foto encontrada para reconhecimento.";
                    return;
                }

                const labeledFaceDescriptors = await Promise.all(
                    imageFiles.map(async file => {
                        const label = file.split('.')[0]; // Remove extensão
                        const imgUrl = `${LABELED_IMAGES_PATH}/${file}`;
                        const img = await faceapi.fetchImage(imgUrl);
                        const detections = await faceapi.detectSingleFace(img).withFaceLandmarks().withFaceDescriptor();

                        if (!detections) {
                            console.warn(`Nenhum rosto detectado em ${file}`);
                            return null;
                        }
                        return new faceapi.LabeledFaceDescriptors(label, [detections.descriptor]);
                    })
                );

                // Filtrar nulos
                const validDescriptors = labeledFaceDescriptors.filter(d => d !== null);

                if (validDescriptors.length > 0) {
                    faceMatcher = new faceapi.FaceMatcher(validDescriptors, 0.6);
                    console.log("Face matcher atualizado com " + validDescriptors.length + " rostos.");
                    msg.textContent = "Pronto! Olhe para a câmera.";
                    startRecognition();
                } else {
                    msg.textContent = "Não foi possível criar modelos faciais.";
                }

            } catch (err) {
                console.error(err);
                msg.textContent = "Erro ao carregar fotos: " + err;
            }
        }

        function startRecognition() {
            isRecognitionRunning = true;
            const canvas = faceapi.createCanvasFromMedia(video);
            document.body.append(canvas);
            const displaySize = { width: video.videoWidth || 640, height: video.videoHeight || 480 };
            faceapi.matchDimensions(canvas, displaySize);

            setInterval(async () => {
                if (isAuthenticating) return; // Para processamento se estiver autenticando

                const detections = await faceapi.detectAllFaces(video).withFaceLandmarks().withFaceDescriptors();
                const resizedDetections = faceapi.resizeResults(detections, displaySize);

                canvas.getContext('2d').clearRect(0, 0, canvas.width, canvas.height);

                const results = resizedDetections.map(d => {
                    if (faceMatcher) {
                        return faceMatcher.findBestMatch(d.descriptor);
                    } else {
                        return { label: 'Desconhecido', distance: 0 };
                    }
                });

                results.forEach((result, i) => {
                    const box = resizedDetections[i].detection.box;
                    const mirroredBox = {
                        x: displaySize.width - box.x - box.width,
                        y: box.y,
                        width: box.width,
                        height: box.height
                    };

                    const label = result.label === 'unknown' ? 'Desconhecido' : result.label;
                    const drawBox = new faceapi.draw.DrawBox(mirroredBox, { label: label });
                    drawBox.draw(canvas);

                    // Tenta login se rosto for reconhecido e não desconhecido
                    if (label !== 'Desconhecido' && label !== 'unknown' && !isAuthenticating) {
                        authenticateUser(label);
                    }
                });

                if (results.length === 0) {
                    msg.textContent = "Aguardando rosto...";
                    document.body.style.background = "#222";
                }

            }, 200);
        }

        async function authenticateUser(faceName) {
            if (isAuthenticating) return;
            isAuthenticating = true;

            msg.textContent = `Identificado: ${faceName}. Entrando...`;
            document.body.style.background = "#0a6";
            loading.style.display = 'flex';

            try {
                console.log("Tentando autenticação via API Serverless...");
                // Tenta primeiro via API Serverless (Vercel)
                const response = await fetch('api/auth', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ face_name: faceName })
                });

                // Verifica se o retorno é JSON válido
                const contentType = response.headers.get("content-type");
                if (!contentType || !contentType.includes("application/json")) {
                    throw new Error("Resposta da API não é JSON (provavelmente 404 ou 500)");
                }

                const data = await response.json();

                if (!data.success) {
                    throw new Error(data.message || 'Erro na autenticação via API');
                }

                console.log("Sucesso via API!");
                finishLogin(data.access_token, data.refresh_token);

            } catch (apiError) {
                console.warn("Falha na API Serverless:", apiError);
                console.log("Tentando fallback para autenticação direta no cliente...");

                // FALLBACK: Autenticação direta no cliente (Supabase JS)
                try {
                    const { data, error } = await supabase.auth.signInWithPassword({
                        email: AUTO_EMAIL,
                        password: AUTO_PASSWORD
                    });

                    if (error) throw error;

                    if (data.session) {
                        console.log("Sucesso via Cliente!");
                        finishLogin(data.session.access_token, data.session.refresh_token);
                    } else {
                        throw new Error("Sessão não criada no fallback.");
                    }
                } catch (clientError) {
                    console.error("Erro fatal na autenticação:", clientError);
                    handleAuthError(clientError.message);
                }
            }
        }

        function finishLogin(accessToken, refreshToken) {
            // Redireciona para a página de login do TimeSupa
            window.location.href = '../login.html#access_token=' + accessToken + '&refresh_token=' + refreshToken;
        }

        function handleAuthError(message) {
            msg.textContent = `Erro: ${message}`;
            document.body.style.background = "#a00";
            loading.style.display = 'none';

            setTimeout(() => {
                isAuthenticating = false;
                document.body.style.background = "#222";
                msg.textContent = "Tente novamente.";
            }, 3000);
        }
    </script>
</body>

</html>